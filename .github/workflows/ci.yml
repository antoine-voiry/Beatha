name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install fastapi httpx uvicorn rpi_ws281x adafruit-circuitpython-neopixel RPi.GPIO
        # Note: Hardware libs might fail on Ubuntu, usually we mock them or use --no-deps if mocking is handled in code.
        # Since we have Emulation Mode, the code handles ImportError, but we need the pip install to succeed or skip.
        # Better: Install only requirements.txt
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install pytest httpx

    - name: Run Backend Tests
      run: |
        # Create config.json for test environment
        echo '{"hardware": {"led_pin": 18, "button_dump_pin": 23, "button_pair_pin": 24, "buzzer_pin": 25, "led_count": 4, "led_brightness": 0.2}, "system": {"dump_dir": "./dumps_test", "serial_port": "/dev/ttyACM0"}, "features": {"emulation_mode_fallback": true}}' > config.json
        pytest tests/

  frontend-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18
        
    - name: Install Frontend Dependencies
      # Assuming src/frontend exists (we need to scaffold it)
      run: |
        if [ -d "src/frontend" ]; then
          cd src/frontend
          npm ci
          npm run build
          # npm run test:unit
          # npx playwright install --with-deps
          # npm run test:e2e
        else
          echo "Frontend directory not found, skipping build."
        fi

  labeler:
    needs: [backend-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/labeler@v4
      with:
        repo-token: "${{ secrets.GITHUB_TOKEN }}"
